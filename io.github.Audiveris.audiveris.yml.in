app-id: io.github.Audiveris.audiveris
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk11
build-options:
  append-path: "/usr/lib/sdk/openjdk11/bin"
command: Audiveris
finish-args:
  # Network access
  - --share=network
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland access
  - --socket=wayland
  # Needs to save files locally
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --env=PATH=/app/bin:/app/jre/bin:/usr/bin
  - --env=JAVA_HOME=/app/jre
modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk11/install.sh

  - name: audiveris
    buildsystem: simple
    build-commands:
      - ln -f gradle-5.6.4-bin.zip gradle/wrapper/gradle-5.6.4-bin.zip
      - sed -Ei 's,https\\://services.gradle.org/distributions/,,' gradle/wrapper/gradle-wrapper.properties
      - sh ./mkgradlerepo.sh
      - install -m 0644 -D -t /app/share/tessdata *.traineddata
      - install -m 0644 -D res/icon-256.png /app/share/icons/hicolor/256x256/apps/io.github.Audiveris.audiveris.png
      - install -m 0644 -D res/icon-64.png /app/share/icons/hicolor/64x64/apps/io.github.Audiveris.audiveris.png
      - install -m 0644 -D res/icon-50.png /app/share/icons/hicolor/50x50/apps/io.github.Audiveris.audiveris.png
      - install -m 0644 -D -m 644 io.github.Audiveris.audiveris.desktop /app/share/applications/io.github.Audiveris.audiveris.desktop
      - install -m 0644 -D -m 644 io.github.Audiveris.audiveris.metainfo.xml /app/share/metainfo/io.github.Audiveris.audiveris.metainfo.xml
      - ./gradlew --offline build
      - tar x -C /app --strip-components=1 -f build/distributions/Audiveris-*.tar
      - sed -i -f add-tessdata-prefix.sed /app/bin/Audiveris
    sources:
      - type: git
        url: https://github.com/Audiveris/audiveris
        branch: master
      - type: file
        url: https://services.gradle.org/distributions/gradle-5.6.4-bin.zip
        sha256: 1f3067073041bc44554d0efe5d402a33bc3d3c93cc39ab684f308586d732a80d
      - type: patch
        path: 0001-add-local-dependencies-mirror.patch
      - type: file
        path: io.github.Audiveris.audiveris.desktop
      - type: file
        path: io.github.Audiveris.audiveris.metainfo.xml
      - type: file
        path: add-tessdata-prefix.sed
      - type: file
        # generated by deps.py
        path: mkgradlerepo.sh
